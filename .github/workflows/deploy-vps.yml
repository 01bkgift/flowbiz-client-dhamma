name: Deploy to VPS (Gated)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or SHA to deploy'
        required: true
        default: 'main'
      action:
        description: 'Action to perform'
        type: choice
        required: true
        options:
          - deploy
          - rollback
      rollback_sha:
        description: 'SHA to rollback to (required if action is rollback)'
        required: false
      dry_run:
        description: 'Dry Run (Verify connectivity only)'
        type: boolean
        required: false
        default: false

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}
          fetch-depth: 0

      - name: Resolve target SHA
        id: resolve_sha
        run: |
          TARGET_SHA=$(git rev-parse HEAD)
          echo "target_sha=$TARGET_SHA" >> $GITHUB_OUTPUT
          echo "Deployment Target SHA: $TARGET_SHA"

      - name: Run Deploy or Rollback Script
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_KNOWN_HOST: ${{ secrets.VPS_KNOWN_HOST }}
          ACTION: ${{ github.event.inputs.action }}
          TARGET_SHA: ${{ steps.resolve_sha.outputs.target_sha }}
          ROLLBACK_SHA: ${{ github.event.inputs.rollback_sha }}
          GITHUB_ACTOR: ${{ github.actor }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          if [ "${ACTION}" = "deploy" ]; then
            bash scripts/deploy_vps_ci.sh
          else
            bash scripts/rollback_vps_ci.sh
          fi

      - name: Upload Deployment Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy_report
          path: deploy_report.json
          retention-days: 90
